class e extends Error{constructor(e,t){super(e),Object.defineProperty(this,"kind",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.kind=t}}var t,r,i,n,s,a,u;!function(e){e.UnknownType="UnknownType",e.UnexpectedEndOfBuffer="UnexpectedEndOfBuffer"}(t||(t={})),function(e){e[e.NullPointer=0]="NullPointer",e[e.Hole=1]="Hole",e[e.Null=2]="Null",e[e.PBigInt=3]="PBigInt",e[e.NBigInt=4]="NBigInt",e[e.Boolean=5]="Boolean",e[e.String=6]="String",e[e.Undefined=7]="Undefined",e[e.UnsignedByte=8]="UnsignedByte",e[e.SignedByte=9]="SignedByte",e[e.UnsignedInt32=10]="UnsignedInt32",e[e.SignedInt32=11]="SignedInt32",e[e.UnsignedFloat64=12]="UnsignedFloat64",e[e.SignedFloat64=13]="SignedFloat64",e[e.Array=14]="Array",e[e.EmptyArray=15]="EmptyArray",e[e.ObjectReference=16]="ObjectReference",e[e.Date=17]="Date",e[e.BooleanObject=18]="BooleanObject",e[e.NumberObject=19]="NumberObject",e[e.StringObject=20]="StringObject",e[e.EmptyObject=21]="EmptyObject",e[e.Object=22]="Object",e[e.RegExp=23]="RegExp",e[e.Map=24]="Map",e[e.EmptyMap=25]="EmptyMap",e[e.WeakMap=26]="WeakMap",e[e.Set=27]="Set",e[e.EmptySet=28]="EmptySet",e[e.WeakSet=29]="WeakSet",e[e.ArrayBuffer=30]="ArrayBuffer",e[e.Int8Array=31]="Int8Array",e[e.Uint8Array=32]="Uint8Array",e[e.Uint8ClampedArray=33]="Uint8ClampedArray",e[e.Int16Array=34]="Int16Array",e[e.Uint16Array=35]="Uint16Array",e[e.Int32Array=36]="Int32Array",e[e.Uint32Array=37]="Uint32Array",e[e.Float32Array=38]="Float32Array",e[e.Float64Array=39]="Float64Array",e[e.DataView=40]="DataView"}(r||(r={})),function(e){e.BigInt="bigint",e.Boolean="boolean",e.Number="number",e.Object="object",e.String="string",e.Undefined="undefined"}(i||(i={})),function(e){e.flagsAsInteger=function(e){return(e.global?1:0)|(e.ignoreCase?2:0)|(e.multiline?4:0)|(e.sticky?8:0)|(e.unicode?16:0)|(e.dotAll?32:0)},e.flagsFromInteger=function(e){let t="";return 1&e&&(t+="g"),2&e&&(t+="i"),4&e&&(t+="m"),8&e&&(t+="y"),16&e&&(t+="u"),32&e&&(t+="s"),t}}(n||(n={})),function(e){e.SUPPORTED="function"==typeof BigInt,e.ZERO=e.SUPPORTED?BigInt(0):null,e.ONE=e.SUPPORTED?BigInt(1):null,e.EIGHT=e.SUPPORTED?BigInt(8):null,e.BYTE=e.SUPPORTED?BigInt(255):null}(s||(s={})),function(e){e.nextPowerOfTwo=function(e){return Math.pow(2,Math.ceil(Math.log2(e)))}}(a||(a={})),function(e){e.constructors=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array,DataView],"function"==typeof BigInt64Array&&e.constructors.push(BigInt64Array),"function"==typeof BigUint64Array&&e.constructors.push(BigUint64Array),e.typedArrayTags=new Map(e.constructors.map(e=>[Object.prototype.toString.call(new e(new ArrayBuffer(0))),r[e.name]])),e.typedArrayTagToConstructor=new Map(e.constructors.map(e=>[r[e.name],e]))}(u||(u={}));const o=new Float64Array(1),c=new Uint8Array(o.buffer);class f{constructor(e){Object.defineProperty(this,"offset",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"_buffer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_objectIDs",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),this._buffer=e}get finished(){return this.offset===this._buffer.length}clean(){this._buffer=null,this.offset=0,this._objectIDs.clear()}read(){const i=this.read8();switch(i){case r.Null:return null;case r.PBigInt:return this.readValueBigInt(!1);case r.NBigInt:return this.readValueBigInt(!0);case r.Boolean:return Boolean(this.read8());case r.String:return this.readString();case r.Undefined:return;case r.UnsignedByte:return this.read8();case r.SignedByte:return-this.read8();case r.UnsignedInt32:return this.read32();case r.SignedInt32:return-this.read32();case r.UnsignedFloat64:return this.readF64();case r.SignedFloat64:return-this.readF64();case r.Array:return this.readValueArray();case r.EmptyArray:return this.createObjectID([]);case r.ObjectReference:return this._objectIDs.get(this.read32());case r.Date:return this.createObjectID(new Date(this.readF64()));case r.BooleanObject:return this.createObjectID(new Boolean(this.read8()));case r.NumberObject:return this.createObjectID(new Number(this.readF64()));case r.StringObject:return this.createObjectID(new String(this.readString()));case r.EmptyObject:return this.createObjectID({});case r.Object:return this.readValueObject();case r.RegExp:return this.createObjectID(new RegExp(this.readString(),n.flagsFromInteger(this.read8())));case r.Map:return this.readValueMap();case r.EmptyMap:return this.createObjectID(new Map);case r.Set:return this.readValueSet();case r.EmptySet:return this.createObjectID(new Set);case r.ArrayBuffer:return this.readValueArrayBuffer();case r.WeakMap:return this.createObjectID(new WeakMap);case r.WeakSet:return this.createObjectID(new WeakSet);case r.Int8Array:case r.Uint8Array:case r.Uint8ClampedArray:case r.Int16Array:case r.Uint16Array:case r.Int32Array:case r.Uint32Array:case r.Float32Array:case r.Float64Array:case r.DataView:return this.readValueTypedArray(i);default:throw new e("Unknown type received: "+i,t.UnknownType)}}readValueTypedArray(e){const t=this.read32();let i;if(this.ensureBytes(t),e===r.Uint8Array)i=this._buffer.subarray(this.offset,this.offset+t);else{const r=new ArrayBuffer(t);i=new(u.typedArrayTagToConstructor.get(e))(r),new Uint8Array(r).set(this._buffer.subarray(this.offset,this.offset+t))}return this.offset+=t,this.createObjectID(i)}readValueArrayBuffer(){const e=this.createObjectID(new ArrayBuffer(this.read32())),t=new Uint8Array(e);for(let e=0,r=t.length;e<r;e++)t[e]=this.read8();return e}readValueSet(){const e=this.createObjectID(new Set);for(;!this.readNullTerminator();)e.add(this.read());return e}readValueMap(){const e=this.createObjectID(new Map);for(;!this.readNullTerminator();)e.set(this.read(),this.read());return e}readValueObject(){const e=this.createObjectID({});for(;!this.readNullTerminator();){const t=this.read(),r=this.read();e[t]=r}return e}readValueArray(){const e=this.createObjectID([]);let t=0;for(;!this.readNullTerminator();)this.read8()!==r.Hole&&(this.offsetBack(),e[t]=this.read()),++t;return e.length=t,e}readString(){const i=this._buffer.indexOf(r.NullPointer,this.offset);if(-1===i)throw new e("Found End-Of-Buffer, expecting a `NullTerminator` before.",t.UnexpectedEndOfBuffer);const n=this._buffer.subarray(this.offset,i),s=f._textDecoder.decode(n);return this.offset=i+1,s}readValueBigInt(e){const t=this.read32();let r=s.ZERO,i=s.ONE;for(let e=0;e<t;e++){const e=this.read8();r+=BigInt(e)*i,i<<=s.EIGHT}return e?-r:r}readNullTerminator(){if(this.watch8()===r.NullPointer)return++this.offset,!0;if(this.finished)throw new e("Found End-Of-Buffer, expecting a `NullTerminator` before.",t.UnexpectedEndOfBuffer);return!1}createObjectID(e){return this._objectIDs.set(this._objectIDs.size,e),e}offsetBack(){--this.offset}watch8(){return this._buffer[this.offset]}read8(){return this.ensureBytes(1),this._buffer[this.offset++]}read32(){return this.ensureBytes(4),this._buffer[this.offset++]*2**24+65536*this._buffer[this.offset++]+256*this._buffer[this.offset++]+this._buffer[this.offset++]}readF64(){return this.ensureBytes(8),c[0]=this._buffer[this.offset++],c[1]=this._buffer[this.offset++],c[2]=this._buffer[this.offset++],c[3]=this._buffer[this.offset++],c[4]=this._buffer[this.offset++],c[5]=this._buffer[this.offset++],c[6]=this._buffer[this.offset++],c[7]=this._buffer[this.offset++],o[0]}ensureBytes(r){if(this.offset+r>this._buffer.length)throw new e(`Found End-Of-Buffer, expecting ${r} byte(s).`,t.UnexpectedEndOfBuffer)}}Object.defineProperty(f,"_textDecoder",{enumerable:!0,configurable:!0,writable:!0,value:new TextDecoder});class l extends Error{constructor(e,t){super(e),Object.defineProperty(this,"kind",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.kind=t}}var h;!function(e){e.UnsupportedType="UnsupportedType",e.UnsupportedSerializedType="UnsupportedSerializedType",e.UnexpectedNullValue="UnexpectedNullValue"}(h||(h={}));const b=new Float64Array(1),d=new Uint8Array(b.buffer);class p{constructor(e,t=null){Object.defineProperty(this,"onUnsupported",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_buffer",{enumerable:!0,configurable:!0,writable:!0,value:new Uint8Array(16)}),Object.defineProperty(this,"_offset",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"_objectIDs",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"_data",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_handlingUnsupported",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this._data=e,this.onUnsupported=t}process(){this.parse(this._data);const e=this._buffer.subarray(0,this._offset);return this._data=null,this._offset=0,this._objectIDs.clear(),this._buffer=null,e}parse(e,t=typeof e){switch(t){case i.BigInt:return this.parseBigInt(e);case i.Boolean:return this.parseBoolean(e);case i.Number:return this.parseNumber(e);case i.Object:return this.parseObject(e);case i.String:return this.parseString(e);case i.Undefined:return this.parseUndefined();default:return this.handleUnsupported(e,t)}}handleUnsupported(e,t){if(this.onUnsupported){if(this._handlingUnsupported)throw new l("The modified value was not serializable.",h.UnsupportedSerializedType);return this._handlingUnsupported=!0,this.parse(this.onUnsupported(e)),void(this._handlingUnsupported=!1)}throw new l(`Unsupported type '${t}'.`,h.UnsupportedType)}parseBigInt(e){const t=e>=s.ZERO?0:1;this.ensureAlloc(5),this.write8(t?r.NBigInt:r.PBigInt);const i=this._offset;this._offset+=4;let n=1===t?-e:e,a=0;for(;n>0;)++a,this.write8(Number(n&s.BYTE)),n>>=s.EIGHT;this.write32At(a,i)}parseBoolean(e){this.write8(r.Boolean),this.write8(e?1:0)}parseNumber(e){const t=this.getNumberType(e);switch(this.write8(t),t){case r.SignedByte:this.write8(-e);break;case r.UnsignedByte:this.write8(e);break;case r.SignedInt32:this.write32(-e);break;case r.UnsignedInt32:this.write32(e);break;case r.SignedFloat64:this.writeF64(-e);break;case r.UnsignedFloat64:this.writeF64(e);break;default:throw new Error("Unreachable code. Got unexpected integer type "+t)}}parseObject(e){if(null===e)return this.parseValueNull();const t=this._objectIDs.get(e);if("number"==typeof t)return this.parseValueReference(t);if(this._objectIDs.set(e,this._objectIDs.size),Array.isArray(e))return this.parseValueArray(e);const r=Object.prototype.toString.call(e);switch(r){case"[object String]":return this.parseValueObjectString(e);case"[object Boolean]":return this.parseValueObjectBoolean(e);case"[object Number]":return this.parseValueObjectNumber(e);case"[object Date]":return this.parseValueObjectDate(e);case"[object RegExp]":return this.parseValueObjectRegExp(e);case"[object Object]":return this.parseValueObjectLiteral(e);case"[object Map]":return this.parseValueObjectMap(e);case"[object Set]":return this.parseValueObjectSet(e);case"[object ArrayBuffer]":return this.parseValueObjectArrayBuffer(e);case"[object WeakMap]":return this.parseValueObjectWeakMap();case"[object WeakSet]":return this.parseValueObjectWeakSet();case"[object Promise]":return this.handleUnsupported(e,"object");default:return this.parseValueObjectFallback(e,r)}}parseString(e){this.write8(r.String),this.writeValueString(e)}parseUndefined(){this.write8(r.Undefined)}parseValueNull(){this.write8(r.Null)}parseValueObjectString(e){this.write8(r.StringObject),this.writeValueString(e.valueOf())}parseValueObjectBoolean(e){this.write8(r.BooleanObject),this.write8(e.valueOf()?1:0)}parseValueObjectNumber(e){this.write8(r.NumberObject),this.writeF64(e.valueOf())}parseValueObjectDate(e){this.write8(r.Date),this.writeF64(e.valueOf())}parseValueObjectRegExp(e){this.write8(r.RegExp),this.writeValueString(e.source),this.write8(n.flagsAsInteger(e))}parseValueObjectLiteral(e){const t=Object.keys(e);if(0===t.length)return this.write8(r.EmptyObject);this.write8(r.Object);for(const r of t)this.parse(r),this.parse(e[r]);this.write8(r.NullPointer)}parseValueObjectMap(e){if(0===e.size)return this.write8(r.EmptyMap);this.write8(r.Map);for(const[t,r]of e.entries())this.parse(t),this.parse(r);this.write8(r.NullPointer)}parseValueObjectSet(e){if(0===e.size)return this.write8(r.EmptySet);this.write8(r.Set);for(const t of e)this.parse(t);this.write8(r.NullPointer)}parseValueObjectArrayBuffer(e){this.write8(r.ArrayBuffer);const t=new Uint8Array(e);this.write32(t.length),this.write(t)}parseValueObjectWeakMap(){this.write8(r.WeakMap)}parseValueObjectWeakSet(){this.write8(r.WeakSet)}parseValueObjectFallback(e,t){const r=u.typedArrayTags.get(t);r?this.writeValueTypedArray(e,r):this.parseValueObjectLiteral(e)}parseValueReference(e){this.write8(r.ObjectReference),this.write32(e)}parseValueArray(e){if(0===e.length)return this.write8(r.EmptyArray);this.ensureAlloc(2),this.write8(r.Array);for(let t=0,i=e.length;t<i;t++)t in e?this.parse(e[t]):this.write8(r.Hole);this.write8(r.NullPointer)}writeValueTypedArray(e,t){this.write8(t),this.write32(e.byteLength),t!==r.Uint8Array&&(e=new Uint8Array(e.buffer)),this.write(e)}write(e){this.ensureAlloc(e.byteLength),this._buffer.set(e,this._offset),this._offset+=e.byteLength}write8(e){this.ensureAlloc(1),this._buffer[this._offset++]=e}write32(e){this.ensureAlloc(4),this.write32At(e,this._offset),this._offset+=4}write32At(e,t){this._buffer[t+3]=e,e>>>=8,this._buffer[t+2]=e,e>>>=8,this._buffer[t+1]=e,e>>>=8,this._buffer[t]=e}writeF64(e){b[0]=e,this.write(d)}writeValueString(e){const t=p._textEncoder.encode(e);if(t.includes(r.NullPointer))throw new l("Unexpected null pointer in serialized string.",h.UnexpectedNullValue);this.write(t),this.write8(r.NullPointer)}getNumberType(e){const t=e<0;if(e%1==0){if(e>=-127&&e<=255)return t?r.SignedByte:r.UnsignedByte;if(e>=-2147483647&&e<=4294967295)return t?r.SignedInt32:r.UnsignedInt32}return t?r.SignedFloat64:r.UnsignedFloat64}ensureAlloc(e){this.expandBuffer(this._offset+e)}expandBuffer(e){if(this._buffer.length<e){const t=this._buffer;this._buffer=new Uint8Array(a.nextPowerOfTwo(e)),this._buffer.set(t)}}}function y(e,t){return new p(e,t).process()}function g(e,t=-1){const r=new f(e);-1!==t&&(r.offset=t);const i=r.read();return r.clean(),i}function w(e,t=-1){const r=new f(e);-1!==t&&(r.offset=t);const i=r.read(),n=r.offset;return r.clean(),{value:i,offset:n===e.byteLength?-1:n}}Object.defineProperty(p,"_textEncoder",{enumerable:!0,configurable:!0,writable:!0,value:new TextEncoder});export{g as deserialize,w as deserializeWithMetadata,y as serialize};
//# sourceMappingURL=index.es.mjs.map
